name: CD

on:
    release:
        types: [published]

    workflow_dispatch:

env:
    APP_TITLE: "MangoÂ³ Store"
    AUTH_CLIENT_ID: ${{ vars.AUTH_CLIENT_ID }}
    AUTH_CLIENT_PROVIDER_APP_URL: ${{ vars.AUTH_CLIENT_PROVIDER_APP_URL }}
    CARGO_TERM_COLOR: always
    DATABASE_URL: postgres://mango3:mango3@127.0.0.1:5432/store_test

jobs:
    build_app:
        runs-on: ubuntu-24.04
        services:
            postgres:
                image: postgres:17-alpine
                env:
                    POSTGRES_USER: mango3
                    POSTGRES_PASSWORD: mango3
                    POSTGRES_DB: store_test
                ports:
                    - 5432:5432
                options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
        steps:
            - uses: actions/checkout@v6
            - uses: ./.github/actions/setup-dioxus
            - uses: ./.github/actions/setup-node
            - run: npm run build
            - run: dx bundle --package store-app --web --release --verbose
              env:
                  APP_TOKEN: ${{ secrets.APP_TOKEN }}
            - uses: actions/upload-artifact@v6
              with:
                  name: store_app_build
                  path: ./target/dx/store-app/release/web/
                  retention-days: 1

    deploy:
        needs: [build_app]
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v6
            - uses: actions/download-artifact@v7
              with:
                  name: store_app_build
                  path: builds/store-app/
            - name: Run deploy script
              run: ${{ secrets.DEPLOY_SCRIPT }}
